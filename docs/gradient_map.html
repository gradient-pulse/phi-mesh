<!doctype html>
<meta charset="utf-8" />
<title>Φ-Mesh — Gradient Map (Pulse Echo)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#0b0f14; --panel:#0f141b; --fg:#e6edf3; --muted:#9fb2c7;
    --line:#7aa2f7; --hot:#cfe6ff; --dot:#9ec3ff; --chip:#122034; --chipbd:#2c3c52;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  #ui{position:fixed;top:12px;left:12px;display:flex;gap:8px;align-items:center;background:rgba(8,12,18,.66);backdrop-filter:saturate(1.1) blur(4px);border:1px solid #233143;padding:8px 10px;border-radius:12px;z-index:10}
  button,select{background:#101a29;border:1px solid #2a3b52;color:var(--fg);border-radius:10px;padding:6px 10px;cursor:pointer}
  button:hover,select:hover{border-color:#39506e}
  button.active{box-shadow:0 0 0 2px #27435f inset}
  #legend{position:fixed;right:12px;top:12px;background:rgba(8,12,18,.66);backdrop-filter:saturate(1.1) blur(4px);border:1px solid #233143;border-radius:12px;max-width:min(520px,48vw);padding:10px 12px;z-index:10}
  #legend h3{margin:0 0 6px 0;font-size:14px}
  #legend p{margin:0 0 6px 0;color:var(--muted);font-size:13px}
  #pulseBadge{float:right;margin-left:10px;background:var(--chip);border:1px solid var(--chipbd);padding:4px 8px;border-radius:999px;color:#cde1ff;font-size:12px}
  svg{position:fixed;inset:0}
  .link{stroke:var(--line);stroke-opacity:.10;stroke-width:1}
  .link.hot{stroke:var(--hot);stroke-opacity:.55;stroke-width:1.6}
  .node circle{fill:#90b8ff;opacity:.25}
  .node.lit circle{opacity:1}
  .label{display:none;font-size:11.5px;fill:#cfe1ff;pointer-events:none}
  .node.lit .label{display:block}
</style>

<div id="ui">
  <button id="play">▶︎ Play</button>
  <button id="pause">⏸︎ Pause</button>
  <label>Speed
    <select id="speed">
      <option>1.0</option><option selected>2.0</option><option>3.0</option>
    </select>
  </label>
</div>

<div id="legend">
  <h3>Pulsed Gradient History: Tags Ignited <span id="pulseBadge">Pulse —</span></h3>
  <p>Each pulse is a gradient. As it passes, its tags ignite; only links between lit tags intensify. Pan/zoom is live.</p>
</div>

<svg id="g" role="img" aria-label="Pulse-driven tag clusters"></svg>

<!-- We rely on docs/data.js to define window.PHI_DATA -->
<script src="data.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
(function(){
  // ---- Guard + extract -----------------------------------------------------
  const DATA = (window.PHI_DATA && typeof window.PHI_DATA === 'object') ? window.PHI_DATA : {nodes:[],links:[],pulses:[]};
  const nodesRaw = Array.isArray(DATA.nodes) ? DATA.nodes : [];
  const linksRaw = Array.isArray(DATA.links) ? DATA.links : [];
  const pulsesRaw = Array.isArray(DATA.pulses) ? DATA.pulses : [];

  // If there is no pulses array, attempt a very light fallback from pulsesByTag
  let pulses = pulsesRaw.slice();
  if (!pulses.length && DATA.pulsesByTag && typeof DATA.pulsesByTag==='object'){
    // synthesize per-pulse entries grouped by (title,date) when available
    const bucket = new Map();
    for(const [tag, arr] of Object.entries(DATA.pulsesByTag)){
      (arr||[]).forEach(p=>{
        const key = (p.title||'Pulse') + '|' + (p.date||'');
        if(!bucket.has(key)) bucket.set(key, {title:p.title||'Pulse', date:p.date||'', tags:[]});
        bucket.get(key).tags.push(tag);
      });
    }
    pulses = [...bucket.values()].sort((a,b)=>String(a.date).localeCompare(String(b.date)));
  }

  // ---- DOM hooks -----------------------------------------------------------
  const svg = d3.select('#g');
  const W = window.innerWidth, H = window.innerHeight;
  svg.attr('viewBox', `0 0 ${W} ${H}`).attr('preserveAspectRatio','xMidYMid meet');

  const root = svg.append('g');           // zoom container
  const linksG = root.append('g');
  const nodesG = root.append('g');

  // ---- Data prep -----------------------------------------------------------
  const id2node = new Map(nodesRaw.map(n => [n.id, {...n}]));
  const nodes = [...id2node.values()];

  const links = linksRaw.map(e => ({
    source: id2node.get(e.source) || e.source,
    target: id2node.get(e.target) || e.target
  })).filter(e => e.source && e.target);

  // ---- Force layout (spread the graph) ------------------------------------
  const sim = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(links).id(d => d.id).distance(55).strength(0.5))
    .force('charge', d3.forceManyBody().strength(-180))
    .force('center', d3.forceCenter(W/2, H/2))
    .force('collide', d3.forceCollide().radius(d => 16).strength(0.8));

  const linkSel = linksG.selectAll('line')
    .data(links)
    .join('line')
    .attr('class','link');

  const nodeSel = nodesG.selectAll('g.node')
    .data(nodes, d => d.id)
    .join(enter => {
      const g = enter.append('g').attr('class','node');
      g.append('circle').attr('r', 6.5);
      g.append('text').attr('class','label').attr('y', -10).attr('text-anchor','middle').text(d=>d.id);
      return g;
    });

  sim.on('tick', () => {
    linkSel.attr('x1', d=>d.source.x).attr('y1', d=>d.source.y)
           .attr('x2', d=>d.target.x).attr('y2', d=>d.target.y);
    nodeSel.attr('transform', d=>`translate(${d.x},${d.y})`);
  });

  // ---- Zoom/pan ------------------------------------------------------------
  const zoom = d3.zoom().scaleExtent([0.4, 4]).on('zoom', ev => root.attr('transform', ev.transform));
  svg.call(zoom);

  // ---- UI controls ---------------------------------------------------------
  const playBtn  = document.getElementById('play');
  const pauseBtn = document.getElementById('pause');
  const speedSel = document.getElementById('speed');
  const badge    = document.getElementById('pulseBadge');

  let playing = false;
  function setPlay(v){
    playing = v;
    playBtn.classList.toggle('active',  v);
    pauseBtn.classList.toggle('active', !v);
  }
  playBtn.onclick  = () => setPlay(true);
  pauseBtn.onclick = () => setPlay(false);

  // ---- Pulse timeline ------------------------------------------------------
  const SPACING = 6; // seconds per pulse (can be changed via URL later if you’d like)
  const frames = (pulses.length ? pulses : [{title:'—',date:'',tags:[]}])
    .map((p,i)=>({ ...p, t: i*SPACING, tags: Array.isArray(p.tags)? p.tags : [] }));

  // ---- Ignite loop (only lit nodes/links pop) ------------------------------
  function drawAt(time){
    if(!frames.length){ badge.textContent='—'; return; }
    const idx = Math.floor(time / SPACING) % frames.length;
    const ev  = frames[idx];
    badge.textContent = ev.title ? (ev.date ? `${ev.title} — ${ev.date}` : ev.title) : 'Pulse';

    const lit = new Set(ev.tags || []);
    nodeSel.classed('lit', d => lit.has(d.id));
    linkSel.classed('hot', d => lit.has(d.source.id) && lit.has(d.target.id));
  }

  let t=0, last=performance.now()/1000;
  function tick(){
    const now = performance.now()/1000;
    const dt  = Math.min(0.05, now - last);
    last = now;
    if(playing) t += dt * parseFloat(speedSel.value||'1.0');
    drawAt(t);
    requestAnimationFrame(tick);
  }
  setPlay(true); // start playing by default
  tick();
})();
</script>

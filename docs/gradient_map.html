<!doctype html>
<meta charset="utf-8" />
<title>Φ-Mesh — Gradient Map (Pulse Echo)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#0b0f14; --panel:#0f141b; --ink:#e6edf3; --muted:#9fb0c4;
    --wire:#9fb7d8; --wire-dim:rgba(159,183,216,.12);
    --lit:#d9ecff; --label:#e6f0ff;
    --ui:#101821; --ui-border:#2a3b49; --ui-accent:#2a7bd8;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  svg{display:block;width:100%;height:100%}
  /* UI */
  #ui{position:fixed;top:12px;left:12px;display:flex;gap:10px;align-items:center;
      background:var(--panel);border:1px solid var(--ui-border);padding:8px 10px;border-radius:12px;z-index:10}
  button,select{background:var(--ui);border:1.5px solid var(--ui-border);color:var(--ink);
      border-radius:10px;padding:6px 10px;cursor:pointer}
  button.active{border-color:var(--ui-accent);outline:2px solid var(--ui-accent);
      box-shadow:0 0 0 2px rgba(42,123,216,.15) inset}
  /* Header + current pulse */
  #legend{position:fixed;top:12px;right:12px;z-index:10;
      background:var(--panel);border:1px solid var(--ui-border);border-radius:12px;padding:10px 12px;max-width:min(48ch,44vw)}
  #legend .hdr{font-weight:700}
  #legend .sub{font-size:12px;color:var(--muted);margin-top:4px}
  #pulse{position:fixed;top:68px;right:12px;z-index:10;
      background:var(--panel);border:1px solid var(--ui-border);border-radius:12px;padding:8px 12px;font-size:13px;color:#d9e6f5;display:none}

  /* Graph styling — faint background + lit cluster */
  .link{stroke:var(--wire); stroke-opacity:.12}
  .link.lit{stroke-opacity:.95}
  .node circle{fill:#9fc9ff; opacity:.18}
  .node.lit circle{fill:var(--lit); opacity:.95}
  .node text{display:none; font-size:12px; fill:var(--label);
             paint-order:stroke; stroke:#0b0f14; stroke-width:3px}
  .node.lit text{display:block}
</style>

<!-- LEFT UI -->
<div id="ui">
  <button id="play" class="active">▶︎ Play</button>
  <button id="pause">⏸︎ Pause</button>
  <label>Speed
    <select id="speed">
      <option selected>1.0</option><option>2.0</option><option>3.0</option>
    </select>
  </label>
</div>

<!-- RIGHT HEADER + PULSE TICKER -->
<div id="legend">
  <div class="hdr">Pulse Gradient History: Tags Ignited</div>
  <div class="sub">Each pulse is a gradient. When it passes, its tags ignite; only links between lit tags intensify. Pan/zoom is live.</div>
</div>
<div id="pulse">—</div>

<!-- GRAPH -->
<svg id="graph" role="img" aria-label="Gradient Map (Pulse-driven)">
  <g id="root">
    <g id="links"></g>
    <g id="nodes"></g>
  </g>
</svg>

<!-- Tag Map data (x,y positions & links) -->
<script src="data.js"></script>
<!-- d3 for zoom/pan (no force run here) -->
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
(async function(){
  // ------- helpers -------
  const waitFor = (fn, ms=3000, step=40) => new Promise(res=>{
    const t=setInterval(()=>{const v=fn(); if(v){clearInterval(t); res(v);}},step);
    setTimeout(()=>{clearInterval(t);res(null)},ms);
  });
  const esc = s=>String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

  // ------- wait for PHI_DATA, then fetch pulses -------
  await waitFor(()=>window.PHI_DATA);
  const DATA = (window.PHI_DATA && typeof window.PHI_DATA==='object') ? window.PHI_DATA : {nodes:[],links:[]};
  const res = await fetch('./echoes.json').catch(()=>null);
  const ej = res ? await res.json().catch(()=>({})) : {};
  const seq = Array.isArray(ej.events) ? ej.events : [];

  const playlist = seq
    .map(e => ({ title: e.title||'Pulse', date: e.date||'', tags: Array.isArray(e.tags)?e.tags:[] }))
    .filter(e => e.tags.length);

  // ------- SVG + layers -------
  const svg  = d3.select('#graph');
  const root = d3.select('#root');
  const linkLayer = d3.select('#links');
  const nodeLayer = d3.select('#nodes');

  // zoom/pan (like Tag Map)
  svg.call(d3.zoom().scaleExtent([0.35, 3]).on('zoom', ev => root.attr('transform', ev.transform)));

  const W = svg.node().clientWidth  || 1280;
  const H = svg.node().clientHeight || 800;
  svg.attr('viewBox', `0 0 ${W} ${H}`).attr('preserveAspectRatio','xMidYMid meet');

  // ------- positions: use Tag Map coords if present; otherwise jitter center -------
  const idToRaw = new Map(DATA.nodes.map(n=>[n.id,n]));
  const nodes = DATA.nodes.map(n => ({
    id: n.id,
    x: (typeof n.x==='number' ? n.x : W/2 + (Math.random()-0.5)*200),
    y: (typeof n.y==='number' ? n.y : H/2 + (Math.random()-0.5)*200),
    r: 4 + Math.sqrt(Math.max(1, (n.centrality ?? 1))) * 2.0
  }));
  const id2node = new Map(nodes.map(n=>[n.id,n]));

  const links = (DATA.links||[]).map(l=>{
    const s = id2node.get(l.source), t = id2node.get(l.target);
    return (s && t) ? {source:s, target:t} : null;
  }).filter(Boolean);

  // ------- draw background graph (faint) -------
  const linkSel = linkLayer.selectAll('line')
    .data(links)
    .join('line')
    .attr('class','link')
    .attr('x1', d=>d.source.x).attr('y1', d=>d.source.y)
    .attr('x2', d=>d.target.x).attr('y2', d=>d.target.y);

  const nodeSel = nodeLayer.selectAll('g.node')
    .data(nodes, d=>d.id)
    .join(enter=>{
      const g = enter.append('g').attr('class','node');
      g.append('circle').attr('r', d=>d.r);
      g.append('text').attr('text-anchor','middle').attr('y', d=>d.r+12).text(d=>d.id);
      g.attr('transform', d=>`translate(${d.x},${d.y})`);
      return g;
    });

  // Start with all nodes dim
  nodeSel.classed('lit', false);

  // ------- UI wiring -------
  const playBtn  = document.getElementById('play');
  const pauseBtn = document.getElementById('pause');
  const speedSel = document.getElementById('speed');
  const pulseBox = document.getElementById('pulse');

  let playing = true;
  playBtn.onclick  = ()=>{ playing=true;  playBtn.classList.add('active'); pauseBtn.classList.remove('active'); };
  pauseBtn.onclick = ()=>{ playing=false; playBtn.classList.remove('active'); pauseBtn.classList.add('active'); };

  // ------- render one pulse: light its tags + links among them -------
  function showEvent(e){
    pulseBox.style.display = 'block';
    pulseBox.innerHTML = `${esc(e.title)} — <span style="color:#aac6ff">${esc(e.date)}</span>`;

    const lit = new Set(e.tags);
    nodeSel.classed('lit', d => lit.has(d.id));
    nodeSel.selectAll('text').style('display', d => lit.has(d.id) ? 'block' : 'none');

    linkSel.classed('lit', d => lit.has(d.source.id) && lit.has(d.target.id));
  }

  // ------- playback loop -------
  let idx = 0;
  let start = performance.now()/1000;

  // show first if available
  if (playlist.length){ showEvent(playlist[0]); }

  function frame(){
    const now = performance.now()/1000;
    if (playing && playlist.length){
      const speed = +speedSel.value || 1;
      const SPACING = 6; // seconds per pulse base
      const virtual = ((now - start) * speed) / SPACING;
      const nextIdx = Math.floor(virtual) % playlist.length;
      if (nextIdx !== idx){
        idx = nextIdx;
        showEvent(playlist[idx]);
      }
    }
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);

  // Safety note if no nodes loaded (shouldn’t happen after waitFor)
  if (!nodes.length){
    const warn = document.createElement('div');
    warn.textContent = 'No graph data loaded (PHI_DATA empty).';
    warn.style.cssText = 'position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);opacity:.7';
    document.body.appendChild(warn);
  }
})();
</script>

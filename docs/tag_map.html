<!DOCTYPE html>
<meta charset="utf-8">
<title>Phi-Mesh Tag Map</title>
<style>
  body { margin: 0; background-color: #000; font-family: sans-serif; color: white; }
  svg { width: 100%; height: 100vh; display: block; }
  .node text { fill: white; font-size: 12px; pointer-events: none; }
  .node ellipse { stroke-width: 0; }
  .link { stroke: white; stroke-opacity: 0.5; }
  .sidebar {
    position: absolute; top: 20px; left: 20px; width: 280px;
    background: rgba(255, 255, 255, 0.05); padding: 10px; font-size: 13px;
  }
  h1 { margin: 10px 0; font-size: 24px; }
</style>
<body>
<div class="sidebar">
  <h1>Phi-Mesh Tag Map</h1>
  <div id="tag-details"><b>Tag Info</b><br>Click a node to see details.</div>
</div>
<svg></svg>

<!-- new unified data source -->
<script src="data.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
  // Expect window.PHI_DATA = { nodes:[{id,centrality}], links:[{source,target}], tagResources:{tag:{papers:[],podcasts:[]}} }
  const DATA = (window.PHI_DATA) ? window.PHI_DATA : {nodes:[],links:[],tagResources:{}};
  const nodes = DATA.nodes || [];
  const links = DATA.links || [];
  const tagResources = DATA.tagResources || {};

  const svg = d3.select("svg"),
        width = window.innerWidth,
        height = window.innerHeight;

  const simulation = d3.forceSimulation(nodes)
      .force("link", d3.forceLink(links).id(d => d.id).distance(90))
      .force("charge", d3.forceManyBody().strength(-450))
      .force("center", d3.forceCenter(width / 2, height / 2));

  const link = svg.append("g")
      .attr("stroke", "#fff").attr("stroke-opacity", 0.6)
    .selectAll("line")
    .data(links).join("line")
      .attr("stroke-width", 1.2);

  const node = svg.append("g")
      .attr("stroke-width", 1.5)
    .selectAll("g")
    .data(nodes).join("g")
      .attr("class", "node")
      .call(d3.drag()
        .on("start", (event) => {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          event.subject.fx = event.subject.x;
          event.subject.fy = event.subject.y;
        })
        .on("drag", (event) => {
          event.subject.fx = event.x;
          event.subject.fy = event.y;
        })
        .on("end", (event) => {
          if (!event.active) simulation.alphaTarget(0);
          event.subject.fx = null;
          event.subject.fy = null;
        })
      );

  node.append("ellipse")
      .attr("rx", d => 6 + Math.sqrt((d.centrality || 0) * 1000))
      .attr("ry", d => 4 + Math.sqrt((d.centrality || 0) * 500))
      .attr("fill", "#00BFFF")
      .on("click", (event, d) => showDetails(d));

  node.append("text")
      .text(d => d.id)
      .attr("x", 10)
      .attr("y", 4);

  simulation.on("tick", () => {
    link
        .attr("x1", d => d.source.x).attr("y1", d => d.source.y)
        .attr("x2", d => d.target.x).attr("y2", d => d.target.y);

    node.attr("transform", d => `translate(${d.x},${d.y})`);
  });

  function showDetails(d) {
    const panel = document.getElementById("tag-details");
    const res = tagResources[d.id] || { papers: [], podcasts: [] };
    let html = `<b>${d.id}</b><br>`;
    html += `Centrality: ${(d.centrality || 0).toFixed(2)}<br>`;
    if (res.papers && res.papers.length) {
      html += "<br><b>Papers</b><br>" + res.papers.map(url => `<a href="${url}" target="_blank">${url}</a>`).join("<br>");
    }
    if (res.podcasts && res.podcasts.length) {
      html += "<br><b>Podcasts</b><br>" + res.podcasts.map(url => `<a href="${url}" target="_blank">${url}</a>`).join("<br>");
    }
    panel.innerHTML = html;
  }
</script>

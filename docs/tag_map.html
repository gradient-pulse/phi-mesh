<!DOCTYPE html>
<meta charset="utf-8" />
<title>Phi-Mesh Tag Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#0b0b0f; --panel:#11141a; --fg:#f5f7fb;
    --muted:#a2adba; --accent:#7db7ff; --accent2:#9ad3ff; --link:#a7c4ff;
    --border: rgba(255,255,255,0.08);
    --linkStroke: rgba(200,215,235,0.30);
    --linkStrokeDim: rgba(200,215,235,0.08);
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .app{display:grid;grid-template-columns:360px 1fr;height:100%}

  /* Sidebar */
  aside{background:linear-gradient(180deg, var(--panel), rgba(25,25,32,.92), rgba(25,25,32,.88));
        border-right:1px solid var(--border);display:flex;flex-direction:column;}
  header{padding:16px 16px 8px}
  h1{margin:0 0 10px 0;font-size:18px;letter-spacing:.2px}
  .search-row{display:flex;gap:8px;align-items:center}
  #tag-search{width:100%;background:#0f131a;border:1px solid var(--border);color:var(--fg);
              padding:10px 12px;border-radius:10px;outline:none}
  .clear-btn{background:#1b2230;border:1px solid var(--border);color:#cbd6e6;cursor:pointer;border-radius:10px;padding:8px 10px}

  .sidebar-section{padding:8px 16px 14px 16px;border-top:1px solid var(--border)}
  .pill{display:inline-block;background:#111b28;border:1px solid var(--border);color:#dbe7ff;
        padding:6px 10px;border-radius:999px;margin-right:8px;font-size:12px}

  .links h4{margin:8px 0 6px 0;font-size:13px;color:#cfe1ff}
  .links a{display:block;color:var(--link);text-decoration:none;margin:2px 0;font-size:13px}
  .links a:hover{text-decoration:underline}

  .empty-hint{color:var(--muted);font-size:13px;padding:16px}

  /* Graph */
  svg{width:100%;height:100%}
  .link{stroke:var(--linkStroke);stroke-width:1.2}
  .link.dim{stroke:var(--linkStrokeDim)}
  .node ellipse{fill:#2cc4ff;stroke:#022433;stroke-width:1.2;filter:drop-shadow(0 0 1px rgba(0,0,0,.3))}
  .node.dim ellipse{opacity:.25}
  .node text{fill:#fff;font-size:11px;pointer-events:none}
  .node.dim text{opacity:.20}
  .focus ellipse{stroke:#bdf;stroke-width:2}
</style>

<script src="data.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="map_node_tooltip.js"></script>

<body>
<div class="app">
  <aside>
    <header>
      <h1>Phi-Mesh Tag Map</h1>
      <div class="search-row">
        <input id="tag-search" placeholder="Search tags…" />
        <button id="clear-search" class="clear-btn" title="Clear">×</button>
      </div>
    </header>

    <div id="tag-meta" class="sidebar-section">
      <div class="empty-hint">Pick a tag to see details.</div>
    </div>
    <div id="tag-links" class="sidebar-section links" style="display:none;">
      <h4>Papers</h4>
      <div id="papers"></div>
      <h4>Podcasts</h4>
      <div id="podcasts"></div>
    </div>
  </aside>

  <svg id="graph" viewBox="0 0 1200 800"></svg>
</div>

<script>
/* ---------- data pickup ---------- */
const rawNodes     = (window.PHI_DATA && PHI_DATA.nodes)        || window.nodes        || [];
const rawLinks     = (window.PHI_DATA && PHI_DATA.links)        || window.links        || [];
const tagResources = (window.PHI_DATA && PHI_DATA.tagResources) || window.tagResources || {};
const tagFirstSeen = (window.PHI_DATA && PHI_DATA.tagFirstSeen) || window.tagFirstSeen || {};

const nodes = rawNodes.map(d => ({
  id: d.id || d.name,
  degree: d.degree || d.deg || 0,
  centrality: d.centrality || d.cent || 0
}));
const links = rawLinks.map(l => ({ source: l.source, target: l.target }));

/* ---------- helpers ---------- */
const byId = new Map(nodes.map(n=>[n.id,n]));
const neighbors = new Map(nodes.map(n=>[n.id,new Set]));
links.forEach(l=>{
  neighbors.get(l.source)?.add(l.target);
  neighbors.get(l.target)?.add(l.source);
});

function normResources(r){
  const toObj = (x)=> typeof x==='string' ? {url:x, title:''} : (x||{});
  const take3 = arr => (arr||[]).slice(0,3).map(toObj);
  return {
    papers: take3(r?.papers),
    podcasts: take3(r?.podcasts),
    callout: r?.callout || ''
  };
}
function trunc(s,max=60){
  if(!s) return '';
  return s.length>max ? s.slice(0,max-1)+'…' : s;
}
const esc = s => String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* ---------- sidebar render ---------- */
const metaEl = document.getElementById('tag-meta');
const linksPanel = document.getElementById('tag-links');
const papersEl = document.getElementById('papers');
const podsEl = document.getElementById('podcasts');

function showDetails(id){
  const n = byId.get(id);
  if(!n){ metaEl.innerHTML = '<div class="empty-hint">Pick a tag to see details.</div>'; linksPanel.style.display='none'; return; }

  metaEl.innerHTML =
    `<div style="margin-bottom:8px;font-weight:600;font-size:18px">${esc(id)}</div>
     <span class="pill">degree ${n.degree}</span>
     <span class="pill">centrality ${Number(n.centrality||0).toFixed(2)}</span>`;

  const res = normResources(tagResources[id] || {});
  const renderList = (el, items)=>{
    el.innerHTML = items.length ? '' : '<div class="empty-hint" style="padding:6px 0 0 0">—</div>';
    items.forEach(({url,title})=>{
      const label = title ? trunc(title,68) : trunc(url.replace(/^https?:\/\//,''),68);
      const a = document.createElement('a');
      a.href = url; a.textContent = label; a.target = '_blank'; a.rel='noopener';
      el.appendChild(a);
    });
  };
  renderList(papersEl, res.papers);
  renderList(podsEl, res.podcasts);
  linksPanel.style.display='block';
}

/* ---------- graph ---------- */
const svg = d3.select('#graph');
const g = svg.append('g'); // zoom container
const link = g.append('g').attr('stroke-linecap','round')
  .selectAll('line').data(links).enter().append('line').attr('class','link');

const node = g.selectAll('.node').data(nodes).enter().append('g').attr('class','node');

const rx = d => 6 + Math.sqrt((d.centrality||0)*900);
const ry = d => 4 + Math.sqrt((d.centrality||0)*450);

node.append('ellipse').attr('rx', rx).attr('ry', ry);
node.append('text').attr('y', d => ry(d)+12).attr('text-anchor','middle').text(d=>d.id);

const sim = d3.forceSimulation(nodes)
  .force('link', d3.forceLink(links).id(d=>d.id).distance(90).strength(.2))
  .force('charge', d3.forceManyBody().strength(-420))
  .force('center', d3.forceCenter(600, 400))
  .force('collision', d3.forceCollide().radius(d=>rx(d)+6));

sim.on('tick', ()=>{
  link.attr('x1', d=>d.source.x).attr('y1', d=>d.source.y)
      .attr('x2', d=>d.target.x).attr('y2', d=>d.target.y);
  node.attr('transform', d=>`translate(${d.x},${d.y})`);
});

/* zoom / pan */
svg.call(d3.zoom().scaleExtent([0.25, 4]).on('zoom', ({transform}) => { g.attr('transform', transform); }));

/* focus logic */
let focused = null;
function applyFocus(id){
  focused = id;
  const N = new Set([id, ...(neighbors.get(id)||[])]);
  node.classed('dim', d=>!N.has(d.id)).classed('focus', d=>d.id===id);
  link.classed('dim', d=> !(N.has(d.source.id) && N.has(d.target.id)));
  showDetails(id);
  sim.force('link').distance(l => (l.source.id===id || l.target.id===id) ? 120 : 90);
  sim.alpha(0.25).restart();
}
function clearFocus(){
  focused = null;
  node.classed('dim', false).classed('focus', false);
  link.classed('dim', false);
  showDetails(null);
  sim.force('link').distance(90);
  sim.alpha(0.15).restart();
}
node.on('click', (_,d)=>applyFocus(d.id));
svg.on('click', (event)=>{
  if(event.target.tagName === 'svg') clearFocus();
});

/* substring search (case/diacritic-insensitive) */
const search = document.getElementById('tag-search');
const clearBtn = document.getElementById('clear-search');
const normalize = s => (s || '').toString().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();

function runSearch(){
  const q = normalize(search.value);
  if(!q){ node.classed('dim', false); link.classed('dim', false); return; }
  const matched = new Set(nodes.filter(n => normalize(n.id).includes(q)).map(n => n.id));
  node.classed('dim', d => !matched.has(d.id));
  link.classed('dim', d => !(matched.has(d.source.id) && matched.has(d.target.id)));
}
let t = null;
search.addEventListener('input', () => { if (t) clearTimeout(t); t = setTimeout(runSearch, 80); });
clearBtn.addEventListener('click', ()=>{ search.value=''; runSearch(); search.focus(); });

/* ---------- tooltips (reusable module) ---------- */
const tooltipHTML = (d) => {
  const n  = byId.get(d.id) || { degree: 0, centrality: 0 };
  const r  = tagResources[d.id] || {};
  const fs = tagFirstSeen[d.id] || {};

  const papers   = (r.papers   || []).slice(0,2);
  const podcasts = (r.podcasts || []).slice(0,2);

  const callout = String(fs.callout || "").split(/(?<=\.)\s+/).slice(0,2).join(" ");
  const metrics = `degree ${n.degree ?? 0} · centrality ${Number(n.centrality||0).toFixed(2)}`;

  const list = (label, items) => {
    if (!items.length) return "";
    const lis = items.map(it => {
      const txt = esc(it.title || it.url.replace(/^https?:\/\//,""));
      return `<li><a href="${esc(it.url)}" target="_blank" rel="noopener">${trunc(txt, 88)}</a></li>`;
    }).join("");
    return `<div style="margin-top:6px"><div style="color:#cfe1ff;font-weight:600;margin-bottom:2px">${label}</div><ul style="margin:0 0 0 14px;padding:0">${lis}</ul></div>`;
  };

  return `
    <div style="font-weight:700;margin-bottom:2px">${esc(d.id)}</div>
    <div style="opacity:0.9;margin-bottom:6px">${metrics}</div>
    ${callout ? `<div>${esc(callout)}</div>` : ``}
    ${list("Papers", papers)}
    ${list("Podcasts", podcasts)}
  `;
};
attachTagTooltips(node, tooltipHTML);

/* initial state */
showDetails(null);
</script>

<!DOCTYPE html>
<meta charset="utf-8" />
<title>Phi-Mesh Tag Map</title>
<style>
  :root{
    --bg:#0b0b0f; --fg:#f5f7fb; --muted:#9aa4b2; --accent:#00BFFF;
    --panel:rgba(255,255,255,0.06); --panel-b:rgba(255,255,255,0.08);
    --chip:rgba(125,211,252,0.14); --link:#7dd3fc;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
  .wrap{display:grid;grid-template-columns:360px 1fr;height:100%}
  /* Sidebar */
  .sidebar{border-right:1px solid var(--panel-b);display:flex;flex-direction:column;min-width:0}
  .head{padding:18px 16px 12px 16px;border-bottom:1px solid var(--panel-b)}
  .head h1{margin:0 0 10px 0;font-size:18px;font-weight:600}
  .search{display:flex;gap:8px;margin-top:6px;margin-bottom:8px}
  .search input{flex:1;background:var(--panel);border:1px solid var(--panel-b);color:var(--fg);border-radius:10px;padding:9px 11px;outline:none}
  .search button{background:transparent;border:1px solid var(--panel-b);color:var(--muted);border-radius:10px;padding:8px 10px;cursor:pointer}
  .list{overflow:auto;flex:1;padding:10px;display:grid;gap:6px}
  .row{display:flex;justify-content:space-between;align-items:center;background:var(--panel);border:1px solid var(--panel-b);padding:9px 10px;border-radius:10px;cursor:pointer}
  .row:hover{background:rgba(125,211,252,0.10)}
  .row .name{font-weight:600;font-size:13px}
  .row .meta{color:var(--muted);font-size:11px}
  .row.active{outline:2px solid var(--accent)}
  .details{border-top:1px solid var(--panel-b);padding:14px 16px;max-height:38%;overflow:auto}
  .details h2{margin:0 0 8px 0;font-size:16px}
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
  .chip{font-size:11px;padding:5px 7px;border-radius:999px;background:var(--chip);border:1px solid rgba(125,211,252,0.25);color:var(--fg)}
  .callout{margin-top:8px;padding:8px;border-radius:10px;background:rgba(255,255,255,0.05);border:1px solid var(--panel-b);font-size:12px;color:var(--fg)}
  .resources{font-size:12px;margin-top:10px}
  .resources a{color:var(--link);text-decoration:none}
  .resources a:hover{text-decoration:underline}
  .section-title{font-weight:600;margin:10px 0 6px 0;font-size:12px;color:#cfe9ff}
  /* Map */
  svg{width:100%;height:100%;display:block}
  .link{stroke:#fff;stroke-opacity:.42}
  .node ellipse{fill:var(--accent);stroke:#fff;stroke-width:0}
  .node text{fill:#fff;font-size:11px;pointer-events:none;dominant-baseline:hanging}
  .dim{opacity:.15}
  .match ellipse{stroke:#fff;stroke-width:1.2}
</style>
<body>
<div class="wrap">
  <aside class="sidebar">
    <div class="head">
      <h1>Phi-Mesh Tag Map</h1>
      <div class="search">
        <input id="tagSearch" type="search" placeholder="Search tags (prefix) …" />
        <button id="clearBtn" title="Clear">✕</button>
      </div>
    </div>
    <div id="list" class="list"></div>
    <div id="details" class="details">Pick a tag to see details.</div>
  </aside>
  <main>
    <svg></svg>
  </main>
</div>

<!-- Data & D3 -->
<script src="data.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const DATA = window.PHI_DATA ? window.PHI_DATA : {nodes:[],links:[],tagResources:{},tagFirstSeen:{}};

// ---------- Build derived info ----------
const degree = {};
DATA.links.forEach(({source,target})=>{
  const s = typeof source==="string"?source:source.id;
  const t = typeof target==="string"?target:target.id;
  degree[s]=(degree[s]||0)+1; degree[t]=(degree[t]||0)+1;
});
const tags = DATA.nodes.map(n=>({
  id:n.id,
  centrality:n.centrality||0,
  degree:degree[n.id]||0,
  resources:(DATA.tagResources||{})[n.id]||{papers:[],podcasts:[]},
  callout:(DATA.tagFirstSeen||{})[n.id]?.callout || null,
  firstPulse:(DATA.tagFirstSeen||{})[n.id]?.pulse || null,
})).sort((a,b)=>(b.degree-a.degree)||(b.centrality-a.centrality)||a.id.localeCompare(b.id));

const listEl = document.getElementById('list');
const detailsEl = document.getElementById('details');
const searchEl = document.getElementById('tagSearch');
const clearBtn = document.getElementById('clearBtn');
let activeTag = null;

// ---------- Sidebar rendering ----------
function renderList(filter=""){
  listEl.innerHTML = "";
  const q = filter.trim().toLowerCase();
  const subset = q ? tags.filter(t=>t.id.toLowerCase().startsWith(q)) : tags;
  subset.forEach(t=>{
    const row = document.createElement('div');
    row.className = 'row' + (t.id===activeTag?' active':'');
    row.dataset.tag = t.id;
    row.onclick = ()=>selectTag(t.id, true);
    const left = document.createElement('div');
    left.innerHTML = `<div class="name">${t.id}</div>
      <div class="meta">deg ${t.degree} · cent ${t.centrality.toFixed(2)}</div>`;
    row.appendChild(left);
    listEl.appendChild(row);
  });
  if (!subset.length){
    const empty = document.createElement('div');
    empty.className='row';
    empty.textContent='No tags match your filter.';
    listEl.appendChild(empty);
  }
}
function truncateTitle(url){ // show first ~25 chars without hammering the DOM
  try{
    const u = new URL(url);
    return (u.pathname.split('/').pop() || u.href).slice(0,25) + (u.href.length>25?'…':'');
  }catch{return (url||'').slice(0,25) + ((url||'').length>25?'…':'');}
}
function renderDetails(tagId){
  const t = tags.find(x=>x.id===tagId);
  if(!t){ detailsEl.textContent='Tag not found.'; return; }
  const pills = [
    `<span class="chip">degree: ${t.degree}</span>`,
    `<span class="chip">centrality: ${t.centrality.toFixed(2)}</span>`
  ];
  let html = `<h2>${t.id}</h2><div class="chips">${pills.join('')}</div>`;
  if (t.callout){
    html += `<div class="callout">${t.callout}${t.firstPulse?` <span style="color:${getComputedStyle(document.body).getPropertyValue('--muted')};font-size:11px">(${t.firstPulse})</span>`:''}</div>`;
  }
  const res = t.resources || {papers:[],podcasts:[]};
  const papers = (res.papers||[]).slice(0,3);
  const pods = (res.podcasts||[]).slice(0,3);
  if (papers.length || pods.length){
    html += `<div class="resources">`;
    if (papers.length){
      html += `<div class="section-title">Papers</div>`;
      html += papers.map(u=>`<div><a href="${u}" target="_blank" rel="noopener">${truncateTitle(u)}</a></div>`).join('');
    }
    if (pods.length){
      html += `<div class="section-title">Podcasts</div>`;
      html += pods.map(u=>`<div><a href="${u}" target="_blank" rel="noopener">${truncateTitle(u)}</a></div>`).join('');
    }
    html += `</div>`;
  }
  detailsEl.innerHTML = html;
}
function highlightList(tagId){
  [...listEl.querySelectorAll('.row')].forEach(el=>{
    el.classList.toggle('active', el.dataset.tag===tagId);
  });
  const active = listEl.querySelector('.row.active');
  if(active){
    const rect = active.getBoundingClientRect();
    const parent = listEl.getBoundingClientRect();
    if (rect.top < parent.top || rect.bottom > parent.bottom){
      active.scrollIntoView({block:'center', behavior:'smooth'});
    }
  }
}

// ---------- SVG map ----------
const svg = d3.select("svg");
const width = window.innerWidth, height = window.innerHeight;

const simulation = d3.forceSimulation(DATA.nodes)
  .force("link", d3.forceLink(DATA.links).id(d=>d.id).distance(90))
  .force("charge", d3.forceManyBody().strength(-420))
  .force("center", d3.forceCenter(width/2, height/2));

const container = svg.append("g");

const link = container.append("g").attr("class","links")
  .selectAll("line").data(DATA.links).join("line")
  .attr("class","link").attr("stroke-width",1.2);

const node = container.append("g").attr("class","nodes")
  .selectAll("g").data(DATA.nodes).join("g")
  .attr("class","node")
  .on("click",(event,d)=>{ selectTag(d.id, false); event.stopPropagation(); })
  .call(d3.drag()
    .on("start", (event,d)=>{ if(!event.active) simulation.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y; })
    .on("drag", (event,d)=>{ d.fx=event.x; d.fy=event.y; })
    .on("end", (event,d)=>{ if(!event.active) simulation.alphaTarget(0); d.fx=null; d.fy=null; })
  );

node.append("ellipse")
  .attr("rx", d=> 5 + Math.sqrt((d.centrality||0)*800))
  .attr("ry", d=> 3.5 + Math.sqrt((d.centrality||0)*400));

node.append("text")
  .attr("x", 10)
  .attr("y", 6)
  .text(d=>d.id);

// pan / zoom
svg.call(d3.zoom().scaleExtent([0.2, 4]).on("zoom", (event)=>{
  container.attr("transform", event.transform);
}));

simulation.on("tick", ()=>{
  link.attr("x1", d=>d.source.x).attr("y1", d=>d.source.y)
      .attr("x2", d=>d.target.x).attr("y2", d=>d.target.y);
  node.attr("transform", d=>`translate(${d.x},${d.y})`);
});

// ---------- Selection + filtering ----------
function selectTag(tagId, fromList){
  activeTag = tagId;
  renderDetails(tagId);
  highlightList(tagId);
  // focus highlight in graph
  node.classed("dim", d=> d.id!==tagId && !isNeighbor(tagId, d.id));
  link.classed("dim", d=> !isEdge(tagId, idOf(d.source)) && !isEdge(tagId, idOf(d.target)));
  node.classed("match", d=> d.id===tagId);
  // optional: center on node
  const nd = DATA.nodes.find(n=>n.id===tagId);
  if (nd){
    // smooth-ish nudge (don’t steal control entirely)
    const t = d3.zoomTransform(svg.node());
    const k = t.k || 1;
    const tx = width/2 - nd.x*k;
    const ty = height/2 - nd.y*k;
    svg.transition().duration(350).call(d3.zoom().translateTo, nd.x, nd.y);
  }
}
function clearSelection(){
  activeTag = null;
  detailsEl.textContent = 'Pick a tag to see details.';
  node.classed("dim", false).classed("match", false);
  link.classed("dim", false);
  highlightList(null);
}
function idOf(x){ return typeof x==="string" ? x : x.id; }
const neighborSet = (()=>{ // build quick neighbor lookup
  const map = new Map();
  DATA.nodes.forEach(n=>map.set(n.id, new Set([n.id])));
  DATA.links.forEach(({source,target})=>{
    const s=idOf(source), t=idOf(target);
    map.get(s).add(t); map.get(t).add(s);
  });
  return map;
})();
function isNeighbor(a,b){ return neighborSet.get(a)?.has(b); }
function isEdge(a,b){ return neighborSet.get(a)?.has(b) && a!==b; }

function applySearchHighlight(q){
  const qq = q.trim().toLowerCase();
  const matches = new Set(tags.filter(t=>!qq || t.id.toLowerCase().startsWith(qq)).map(t=>t.id));
  node.classed("dim", d=> !matches.has(d.id));
  link.classed("dim", d=> !(matches.has(idOf(d.source)) && matches.has(idOf(d.target))));
  // if there’s exactly one match, pre-select it visually (but don’t open details yet)
  if(matches.size===1 && !activeTag){
    const only = [...matches][0];
    node.classed("match", d=> d.id===only);
  }else{
    node.classed("match", d=> d.id===activeTag);
  }
}

// ---------- Events ----------
searchEl.addEventListener('input', (e)=>{
  const val = e.target.value || "";
  renderList(val);
  applySearchHighlight(val);
});
searchEl.addEventListener('keydown', (e)=>{
  if(e.key==='Escape'){ // only when focused
    e.stopPropagation();
    searchEl.value = '';
    renderList('');
    applySearchHighlight('');
  }
  if(e.key==='Enter'){
    const q = (searchEl.value||'').trim().toLowerCase();
    if(!q) return;
    const first = tags.find(t=>t.id.toLowerCase().startsWith(q));
    if(first){ selectTag(first.id, true); }
  }
});
clearBtn.addEventListener('click', ()=>{
  searchEl.value=''; renderList(''); applySearchHighlight('');
});
window.addEventListener('keydown', (e)=>{
  // quick focus shortcut; don’t trap Esc globally
  if(e.key==='/' && document.activeElement!==searchEl){
    e.preventDefault(); searchEl.focus();
  }
});

// click empty space clears selection
svg.on("click", ()=> clearSelection());

// initial paint
renderList('');
applySearchHighlight('');
</script>

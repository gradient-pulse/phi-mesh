<!DOCTYPE html>
<meta charset="utf-8" />
<title>Phi-Mesh Tag Map</title>
<style>
  :root {
    --bg: #000; --fg: #fff; --muted: #b9c1cc;
    --accent: #00BFFF; --panel: rgba(0,0,0,0.55);
    --chip: rgba(255,255,255,0.10);
  }
  html, body { margin: 0; background: var(--bg); color: var(--fg); height: 100%; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; }
  svg { width: 100%; height: 100vh; display: block; }

  /* Top-left HUD */
  .hud {
    position: absolute; top: 16px; left: 16px; width: 360px;
    background: var(--panel); padding: 12px 12px 10px 12px; border-radius: 12px;
    backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
    box-shadow: 0 6px 22px rgba(0,0,0,0.35);
  }
  .hud h1 { margin: 0 0 10px 0; font-size: 22px; line-height: 1.15; }
  .search {
    position: relative; margin: 6px 0 4px 0;
  }
  .search input {
    width: 100%; padding: 10px 34px 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.06); color: var(--fg); outline: none; font-size: 14px;
  }
  .search button {
    position: absolute; right: 6px; top: 50%; transform: translateY(-50%);
    background: transparent; border: 0; color: var(--muted); cursor: pointer; font-size: 16px; padding: 4px 6px;
  }
  .help { color: var(--muted); font-size: 12px; margin-top: 4px; }

  /* Node & label styling */
  .link { stroke: #fff; stroke-opacity: 0.42; }
  .node ellipse { fill: var(--accent); stroke: #fff; stroke-width: 0; }
  .node text { fill: #fff; font-size: 11px; pointer-events: none; dominant-baseline: hanging; } /* label under node */
  .dim { opacity: 0.15; }
  .match ellipse { stroke: #fff; stroke-width: 1.2; }
</style>
<body>
  <div class="hud">
    <h1>Phi-Mesh Tag Map</h1>
    <div class="search">
      <input id="tagSearch" type="search" placeholder="Search tag (prefix)… e.g., n → shows tags starting with N" />
      <button id="clearBtn" title="Clear">✕</button>
    </div>
    <div class="help">Type to highlight tags that <em>start with</em> your text (case-insensitive). Press Esc to clear. Click a node for details.</div>
  </div>

  <svg></svg>

  <!-- Data payload (nodes, links, resources, first-seen) -->
  <script src="data.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
  // --------------------------------------------------------------------
  // Data
  // --------------------------------------------------------------------
  const DATA = (window.PHI_DATA) ? window.PHI_DATA : {nodes:[],links:[],tagResources:{},tagFirstSeen:{}};

  const svg = d3.select("svg");
  const width = window.innerWidth, height = window.innerHeight;

  // Zoom/pan
  const zoom = d3.zoom()
      .scaleExtent([0.25, 4])
      .on("zoom", (event) => g.attr("transform", event.transform));
  svg.call(zoom);

  // Root group for all content
  const g = svg.append("g");

  // Links
  const link = g.append("g")
    .attr("stroke", "#fff").attr("stroke-opacity", 0.42)
    .selectAll("line")
    .data(DATA.links)
    .join("line")
    .attr("class", "link")
    .attr("stroke-width", 1);

  // Nodes (ellipse + label underneath)
  const node = g.append("g")
    .selectAll("g")
    .data(DATA.nodes)
    .join("g")
      .attr("class", "node")
      .call(drag(sim()));

  node.append("ellipse")
      .attr("rx", d => 5 + Math.sqrt((d.centrality || 0.0001) * 700))  // slightly smaller
      .attr("ry", d => 3.8 + Math.sqrt((d.centrality || 0.0001) * 350))
      .attr("fill", "#00BFFF");

  node.append("text")
      .text(d => d.id)
      .attr("x", 0)
      .attr("y", d => (3.8 + Math.sqrt((d.centrality || 0.0001) * 350)) + 3)  // label just under node
      .attr("text-anchor", "middle");

  // Sidebar-on-click (reuses your existing left panel behavior via alert-like quick view)
  node.on("click", (event, d) => {
    const res = (DATA.tagResources && DATA.tagResources[d.id]) || {papers:[], podcasts:[]};
    const first = DATA.tagFirstSeen && DATA.tagFirstSeen[d.id];
    // Limit to 3 + pretty titles (trim)
    const trim = (s, n=48) => (s && s.length>n ? s.slice(0,n) + "…" : s);
    const list = (arr)=> (arr||[]).slice(0,3).map(x=>{
      const t = (typeof x === 'string') ? x : (x.title || x.url || '');
      const u = (typeof x === 'string') ? x : (x.url || x.title || '');
      return `• ${trim(t)}\n   ${u}`;
    }).join("\n");

    const msg = [
      `${d.id}`,
      first && first.callout ? `\nCall-out (${first.pulse || "first-seen"}):\n${first.callout}\n` : "",
      res.papers && res.papers.length ? `Papers:\n${list(res.papers)}` : "Papers: —",
      res.podcasts && res.podcasts.length ? `Podcasts:\n${list(res.podcasts)}` : "Podcasts: —"
    ].filter(Boolean).join("\n");
    // Replace this with your real sidebar if you have one wired;
    // keeping it simple here so the search patch is clean & portable.
    console.info(msg);
  });

  // Simulation
  function sim(){
    const simulation = d3.forceSimulation(DATA.nodes)
      .force("link", d3.forceLink(DATA.links).id(d => d.id).distance(90))
      .force("charge", d3.forceManyBody().strength(-420))
      .force("center", d3.forceCenter(width/2, height/2))
      .on("tick", () => {
        link.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
        node.attr("transform", d => `translate(${d.x},${d.y})`);
      });
    return simulation;
  }

  function drag(simulation) {
    return d3.drag()
      .on("start", (event) => {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
      })
      .on("drag", (event) => {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
      })
      .on("end", (event) => {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
      });
  }

  // --------------------------------------------------------------------
  // Prefix Search UI
  // --------------------------------------------------------------------
  const searchEl = document.getElementById("tagSearch");
  const clearBtn = document.getElementById("clearBtn");

  function applyPrefixFilter(prefix){
    const q = (prefix || "").trim().toLowerCase();
    if (!q){
      node.classed("dim", false).classed("match", false);
      link.classed("dim", false);
      return;
    }
    const matches = new Set(DATA.nodes.filter(n => n.id.toLowerCase().startsWith(q)).map(n => n.id));
    node.classed("match", d => matches.has(d.id))
        .classed("dim",   d => !matches.has(d.id));
    // dim links that don't connect two matches
    link.classed("dim", d => !(matches.has(d.source.id) && matches.has(d.target.id)));

    // Auto-zoom to the mean position of matches (nice UX)
    if (matches.size){
      const sel = DATA.nodes.filter(n => matches.has(n.id));
      const cx = d3.mean(sel, d=>d.x), cy = d3.mean(sel, d=>d.y);
      const t = d3.zoomIdentity.translate(width/2 - cx, height/2 - cy);
      svg.transition().duration(300).call(zoom.transform, t);
    }
  }

  searchEl.addEventListener("input", (e) => applyPrefixFilter(e.target.value));
  searchEl.addEventListener("keydown", (e) => {
    if (e.key === "Escape"){ searchEl.value = ""; applyPrefixFilter(""); }
  });
  clearBtn.addEventListener("click", () => { searchEl.value = ""; applyPrefixFilter(""); });

  </script>
</body>

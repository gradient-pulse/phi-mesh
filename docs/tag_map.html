<!DOCTYPE html>
<meta charset="utf-8">
<title>Phi-Mesh Tag Map</title>
<style>
  :root{
    --bg:#000; --fg:#fff; --muted:#c7c7c7;
    --node:#00BFFF; --link:#9aa4b2;
    --paper:#9AE6B4;   /* soft green */
    --pod:#C084FC;     /* soft purple */
    --panel:rgba(255,255,255,.06);
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .sidebar{
    position:absolute; top:16px; left:16px; max-width:360px; padding:14px 16px;
    background:var(--panel); backdrop-filter:saturate(120%) blur(4px); border-radius:12px;
    border:1px solid rgba(255,255,255,.08); pointer-events:auto;
  }
  h1{margin:0 0 8px 0; font-size:24px; line-height:1.15;}
  .tname{font-weight:700; font-size:16px; margin:8px 0 6px 0;}
  .meta{color:var(--muted); font-size:12px; margin-bottom:8px;}
  .sec{margin-top:10px; font-weight:700; font-size:12px; color:#e7e7e7;}
  .list{font-size:12px; line-height:1.25;}       /* D: smaller font */
  .list a{display:block; color:var(--paper); text-decoration:none; word-break:break-all; margin:2px 0;}
  .list a.pod{color:var(--pod);}
  .list a:hover{text-decoration:underline;}
  .callout{margin-top:10px; font-size:13px; color:#f1f1f1;}
  svg{width:100%; height:100vh; display:block; cursor:grab;}
  svg:active{cursor:grabbing;}
  .node text{fill:#fff; font-size:11px; pointer-events:none; text-shadow:0 0 2px #000;}  /* B: smaller, readable */
  .node ellipse{stroke-width:0;}
  .link{stroke:var(--link); stroke-opacity:.55;}
</style>
<body>
<div class="sidebar" id="panel">
  <h1>Phi-Mesh Tag Map</h1>
  <div class="tname">Click a node…</div>
  <div class="meta">Centrality —</div>
  <div class="sec">Papers</div>
  <div class="list" id="papers"></div>
  <div class="sec">Podcasts</div>
  <div class="list" id="pods"></div>
  <div class="callout" id="callout"></div>
</div>

<svg id="scene"></svg>

<script src="data.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const DATA = (window.PHI_DATA) ? window.PHI_DATA : {nodes:[], links:[], tagResources:{}, tagFirstSeen:{}};

function trimTitle(urlOrTitle, n=25){
  const isUrl = /^https?:\/\//i.test(urlOrTitle);
  let t = urlOrTitle;
  if(isUrl){
    try { const u = new URL(urlOrTitle); t = decodeURIComponent(u.pathname.split('/').filter(Boolean).pop() || u.host); }
    catch{ t = urlOrTitle; }
  }
  return (t.length>n)? (t.slice(0,n) + '…') : t;
}
function norm(items=[]){
  return items.map(x=>{
    if(typeof x === 'string') return {title: trimTitle(x), url:x};
    return {title: trimTitle(x.title || x.url || ''), url: x.url || x.title || ''};
  });
}

const svg = d3.select("#scene");
const g = svg.append("g");

// pan/zoom
const zoom = d3.zoom().scaleExtent([0.2, 4]).on("zoom", (e)=> g.attr("transform", e.transform));
svg.call(zoom);

// C: slightly smaller nodes
const sim = d3.forceSimulation(DATA.nodes)
  .force("link", d3.forceLink(DATA.links).id(d=>d.id).distance(90))
  .force("charge", d3.forceManyBody().strength(-420))
  .force("center", d3.forceCenter(window.innerWidth/2, window.innerHeight/2));

const link = g.append("g")
  .selectAll("line")
  .data(DATA.links).join("line")
  .attr("class","link")
  .attr("stroke-width",1.0);

const node = g.append("g")
  .selectAll("g")
  .data(DATA.nodes).join("g")
  .attr("class","node")
  .call(d3.drag()
    .on("start", (event,d)=>{ if(!event.active) sim.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y; })
    .on("drag", (event,d)=>{ d.fx=event.x; d.fy=event.y; })
    .on("end",  (event,d)=>{ if(!event.active) sim.alphaTarget(0); d.fx=null; d.fy=null; }))
  .on("click", (_,d)=> showDetails(d.id));

node.append("ellipse")
  .attr("rx", d=> 4 + Math.sqrt((d.centrality||0)*600))  // C: smaller base/scales
  .attr("ry", d=> 3 + Math.sqrt((d.centrality||0)*300))
  .attr("fill","var(--node)");

// B: label centered under node
node.append("text")
  .attr("text-anchor","middle")
  .attr("dy", d=> 10 + Math.sqrt((d.centrality||0)*300)) // sit just under ellipse
  .text(d=> d.id);

sim.on("tick", ()=>{
  link.attr("x1", d=>d.source.x).attr("y1", d=>d.source.y)
      .attr("x2", d=>d.target.x).attr("y2", d=>d.target.y);
  node.attr("transform", d=>`translate(${d.x},${d.y})`);
});

// sidebar
const panel = document.getElementById('panel');
const papersEl = document.getElementById('papers');
const podsEl = document.getElementById('pods');
const calloutEl = document.getElementById('callout');

function showDetails(tagId){
  const nd = DATA.nodes.find(n=>n.id===tagId) || {centrality:0};
  panel.querySelector('.tname').textContent = tagId;
  panel.querySelector('.meta').textContent = `Centrality ${ (nd.centrality||0).toFixed(2) }`;

  const res = (DATA.tagResources && DATA.tagResources[tagId]) ? DATA.tagResources[tagId] : {papers:[], podcasts:[]};
  const papers = norm(res.papers).slice(0,3);   // A: cap 3
  const pods   = norm(res.podcasts).slice(0,3); // A: cap 3

  papersEl.innerHTML = papers.length ? papers.map(p=>`<a class="paper" style="color:var(--paper)" href="${p.url}" target="_blank" rel="noopener">${p.title}</a>`).join("") : `<span style="color:var(--muted)">—</span>`;
  podsEl.innerHTML   = pods.length   ? pods.map(p=>`<a class="pod"   style="color:var(--pod)"   href="${p.url}" target="_blank" rel="noopener">${p.title}</a>`).join("") : `<span style="color:var(--muted)">—</span>`;

  const first = (DATA.tagFirstSeen && DATA.tagFirstSeen[tagId]) || null;
  calloutEl.textContent = first && first.callout ? `Call-out (${first.pulse}): ${first.callout}` : "";
}
</script>

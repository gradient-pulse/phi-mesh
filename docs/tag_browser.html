<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Phi-Mesh Tag Browser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0b0f;--fg:#f5f7fb;--muted:#9aa4b2;--accent:#7dd3fc;
      --panel:rgba(255,255,255,0.06);--chip:rgba(125,211,252,0.14)
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji")}
    header{padding:16px 20px 8px;display:flex;gap:12px;align-items:center;
      border-bottom:1px solid rgba(255,255,255,0.08)}
    header h1{margin:0;font-size:20px;font-weight:600;letter-spacing:.2px}
    .search-wrap{display:flex;gap:8px;align-items:center;flex:1;max-width:520px}
    input[type="search"]{flex:1;background:var(--panel);border:1px solid rgba(255,255,255,0.08);color:var(--fg);
      border-radius:12px;padding:10px 12px;outline:none}
    .clear-btn{background:var(--panel);border:1px solid rgba(255,255,255,0.08);
      border-radius:10px;padding:8px 10px;cursor:pointer}
    main{display:grid;grid-template-columns:340px 1fr;height:calc(100% - 66px)}
    aside{border-right:1px solid rgba(255,255,255,0.08);overflow-y:auto}
    .details{padding:16px 20px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px}
    .chip{font-size:12px;padding:6px 8px;border-radius:999px;background:var(--chip);
      border:1px solid rgba(125,211,252,0.25);color:var(--fg)}
    .links h3{margin:12px 0 6px 0;font-size:13px;color:var(--muted)}
    .links a{display:block;font-size:13px;line-height:1.4;color:var(--accent);
      text-decoration:none;word-break:break-word;margin:2px 0}
    .links a:hover{text-decoration:underline}
    .empty{color:var(--muted)}
    /* optional: show a soft divider */
    .hr{height:1px;background:rgba(255,255,255,0.06);margin:10px 0}
    /* list pane (kept minimal for now) */
    .list{padding:12px 12px 0;display:grid;gap:8px}
    .tag{padding:10px 12px;border-radius:12px;background:var(--panel);
      border:1px solid rgba(255,255,255,0.06);cursor:pointer}
    .tag .name{font-weight:600}
    .tag .meta{color:var(--muted);font-size:12px}
    .hidden{display:none}
    /* canvas host */
    #graphHost{height:100%;position:relative}
  </style>
</head>
<body>
  <header>
    <h1>Phi-Mesh Tag Browser</h1>
    <div class="search-wrap">
      <input id="search" type="search" placeholder="Filter tags… (fuzzy, case-insensitive)" />
      <button id="clear" class="clear-btn" title="Clear">×</button>
    </div>
  </header>

  <main>
    <aside>
      <div id="details" class="details empty">Pick a tag on the graph or from the list to see details.</div>
      <div class="hr"></div>
      <div id="list" class="list"></div>
    </aside>
    <section id="graphHost">
      <!-- your graph page/script embeds separately if needed -->
    </section>
  </main>

  <!-- Data blob produced by your workflow -->
  <script src="data.js"></script>
  <script>
  // ===== Helpers =============================================================

  const DATA = window.PHI_DATA || {nodes:[],links:[],tagResources:{}};

  const degree = {};
  for (const {source,target} of (DATA.links||[])) {
    degree[source] = (degree[source]||0)+1;
    degree[target] = (degree[target]||0)+1;
  }

  const tags = (DATA.nodes||[]).map(n => ({
    id: n.id,
    centrality: n.centrality ?? 0,
    degree: degree[n.id] || 0,
    resources: (DATA.tagResources||{})[n.id] || {papers:[],podcasts:[]},
  })).sort((a,b) => (b.degree - a.degree) || (b.centrality - a.centrality) || a.id.localeCompare(b.id));

  const listEl    = document.getElementById('list');
  const detailsEl = document.getElementById('details');
  const searchEl  = document.getElementById('search');
  const clearBtn  = document.getElementById('clear');

  function truncateText(s, max=80){
    if (!s) return '';
    if (s.length <= max) return s;
    return s.slice(0, max-1) + '…';
  }
  function truncateUrl(u, max=80){
    try {
      const {host, pathname} = new URL(u);
      const path = pathname.replace(/\/$/, '');
      const base = host + (path ? path : '');
      return truncateText(base, max);
    } catch {
      return truncateText(u, max);
    }
  }
  // Accept string or {url,title} or {href,text}
  function toLinkItems(list){
    if (!Array.isArray(list)) return [];
    const out = [];
    for (const item of list){
      if (typeof item === 'string'){
        out.push({ href:item, label:truncateUrl(item) });
      } else if (item && typeof item === 'object'){
        const href = item.url || item.href || '';
        if (!href) continue;
        const title = item.title || item.text || '';
        out.push({ href, label: truncateText(title || truncateUrl(href), 80) });
      }
    }
    return out;
  }

  // ===== Rendering ===========================================================

  function renderList(filter="") {
    listEl.innerHTML = "";
    const q = filter.trim().toLowerCase();
    const subset = q ? tags.filter(t => t.id.toLowerCase().includes(q)) : [];
    for (const t of subset){
      const row = document.createElement('div');
      row.className = 'tag';
      row.onclick = () => renderDetails(t.id);
      row.innerHTML = `
        <div class="name">${t.id}</div>
        <div class="meta">deg <span>${t.degree}</span> · cent ${t.centrality.toFixed(2)}</div>
      `;
      listEl.appendChild(row);
    }
  }

  function renderDetails(tagId){
    const t = tags.find(x => x.id === tagId);
    if (!t){
      detailsEl.className = 'details empty';
      detailsEl.textContent = 'Tag not found.';
      return;
    }
    detailsEl.className = 'details';
    const pills = [
      `<span class="chip">degree ${t.degree}</span>`,
      `<span class="chip">centrality ${t.centrality.toFixed(2)}</span>`
    ];

    // normalize resources (show max 3 each)
    const papers   = toLinkItems(t.resources.papers).slice(0,3);
    const podcasts = toLinkItems(t.resources.podcasts).slice(0,3);

    let html = `<h2 style="margin:0 0 6px 0">${t.id}</h2>`;
    html += `<div class="chips">${pills.join('')}</div>`;

    if (papers.length || podcasts.length){
      html += `<div class="links">`;
      if (papers.length){
        html += `<h3>Papers</h3>`;
        for (const p of papers){
          html += `<a href="${p.href}" target="_blank" rel="noopener">${p.label}</a>`;
        }
      }
      if (podcasts.length){
        html += `<h3>Podcasts</h3>`;
        for (const p of podcasts){
          html += `<a href="${p.href}" target="_blank" rel="noopener">${p.label}</a>`;
        }
      }
      html += `</div>`;
    } else {
      html += `<div class="empty" style="margin-top:10px">No linked resources yet.</div>`;
    }

    detailsEl.innerHTML = html;
  }

  // ===== Wire up =============================================================

  searchEl.addEventListener('input', e => renderList(e.target.value));
  clearBtn.addEventListener('click', () => { searchEl.value = ''; renderList(''); });

  // If you want a default selection (e.g., largest degree) pick first:
  if (tags.length){
    renderDetails(tags[0].id);
  }
  // Don’t pre-populate the list—only when searching:
  renderList('');
  </script>
</body>
</html>

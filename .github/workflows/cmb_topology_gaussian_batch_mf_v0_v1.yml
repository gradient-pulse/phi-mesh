name: "CMB Topology Gaussian â€” Batch Dispatcher (MF V0+V1)"

on:
  workflow_dispatch:
    inputs:
      target_workflow_file:
        description: "Workflow filename to dispatch (must exist in .github/workflows/)"
        required: true
        default: "cmb_topology_gaussian_control__mf_v0_v1.yml"

      lmax_list:
        description: "Comma-separated lmax values (e.g. 128,192,256,320)"
        required: true
        default: "128,192,256,320"

      gauss_seed_min:
        description: "Min gauss_seed (inclusive)"
        required: true
        default: "950"
      gauss_seed_max:
        description: "Max gauss_seed (inclusive)"
        required: true
        default: "989"

      dat_url:
        description: "Release asset URL for dat_klm"
        required: true
        default: "https://github.com/gradient-pulse/phi-mesh/releases/download/data-2026-02-15-planck-lensing-R3/planck_pr3_lensing_mv_dat_klm.fits"
      mf_url:
        description: "Release asset URL for mf_klm"
        required: true
        default: "https://github.com/gradient-pulse/phi-mesh/releases/download/data-2026-02-15-planck-lensing-R3/planck_pr3_lensing_mv_mf_klm.fits"

      nside:
        description: "HEALPix nside"
        required: true
        default: "256"
      n_sims:
        description: "Number of surrogates"
        required: true
        default: "2000"
      seed:
        description: "Surrogate RNG seed"
        required: true
        default: "731"

      n_nu:
        description: "Number of thresholds"
        required: true
        default: "61"
      nu_min:
        description: "Min threshold"
        required: true
        default: "-3.0"
      nu_max:
        description: "Max threshold"
        required: true
        default: "3.0"

      run_note_prefix:
        description: "Prefix for run_note"
        required: false
        default: "batch"

      throttle_seconds:
        description: "Sleep between dispatches (helps GitHub not drop calls)"
        required: true
        default: "2"

permissions:
  actions: write
  contents: read

concurrency:
  group: "gaussian-batch-dispatcher"
  cancel-in-progress: false

jobs:
  dispatch:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Dispatch batch
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref_name }}

          TARGET_WORKFLOW_FILE: ${{ inputs.target_workflow_file }}
          LMAX_LIST: ${{ inputs.lmax_list }}
          GAUSS_MIN: ${{ inputs.gauss_seed_min }}
          GAUSS_MAX: ${{ inputs.gauss_seed_max }}

          DAT_URL: ${{ inputs.dat_url }}
          MF_URL: ${{ inputs.mf_url }}

          NSIDE: ${{ inputs.nside }}
          N_SIMS: ${{ inputs.n_sims }}
          SEED: ${{ inputs.seed }}

          N_NU: ${{ inputs.n_nu }}
          NU_MIN: ${{ inputs.nu_min }}
          NU_MAX: ${{ inputs.nu_max }}

          RUN_NOTE_PREFIX: ${{ inputs.run_note_prefix }}
          THROTTLE: ${{ inputs.throttle_seconds }}
        run: |
          set -euo pipefail

          is_int() { [[ "$1" =~ ^-?[0-9]+$ ]]; }

          if ! is_int "$GAUSS_MIN" || ! is_int "$GAUSS_MAX"; then
            echo "ERROR: gauss_seed_min/max must be integers."
            exit 1
          fi
          if ! is_int "$THROTTLE"; then
            echo "ERROR: throttle_seconds must be an integer."
            exit 1
          fi

          GAUSS_MIN_INT="$GAUSS_MIN"
          GAUSS_MAX_INT="$GAUSS_MAX"
          THROTTLE_INT="$THROTTLE"

          if (( GAUSS_MAX_INT < GAUSS_MIN_INT )); then
            echo "ERROR: gauss_seed_max must be >= gauss_seed_min."
            exit 1
          fi
          if (( THROTTLE_INT < 0 )); then THROTTLE_INT=0; fi

          IFS=',' read -ra LMAX_ARR <<< "$LMAX_LIST"

          total=0
          failed=0

          for raw_l in "${LMAX_ARR[@]}"; do
            lmax="$(echo "$raw_l" | xargs)"
            [[ -z "$lmax" ]] && continue

            if ! is_int "$lmax"; then
              echo "ERROR: lmax is not an integer: '$lmax'"
              exit 1
            fi

            for ((gs=GAUSS_MIN_INT; gs<=GAUSS_MAX_INT; gs++)); do
              note="${RUN_NOTE_PREFIX} lmax=${lmax} gauss_seed=${gs}"

              # Build JSON safely without heredocs (avoids YAML indentation pitfalls)
              payload=$(
                python -c "import json,sys; print(json.dumps({
                  'ref': '${REF}',
                  'inputs': {
                    'dat_url': '${DAT_URL}',
                    'mf_url': '${MF_URL}',
                    'lmax': str(${lmax}),
                    'nside': '${NSIDE}',
                    'n_sims': '${N_SIMS}',
                    'seed': '${SEED}',
                    'gauss_seed': str(${gs}),
                    'n_nu': '${N_NU}',
                    'nu_min': '${NU_MIN}',
                    'nu_max': '${NU_MAX}',
                    'run_note': '${note}'
                  }
                }))"
              )

              echo "Dispatching: lmax=${lmax} gauss_seed=${gs}"
              http_code=$(curl -sS -o /tmp/resp.txt -w "%{http_code}" \
                -X POST \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${GH_TOKEN}" \
                "https://api.github.com/repos/${REPO}/actions/workflows/${TARGET_WORKFLOW_FILE}/dispatches" \
                -d "${payload}" || true)

              if [[ "${http_code}" != "204" ]]; then
                echo "!! Dispatch failed (HTTP ${http_code}) for lmax=${lmax} gauss_seed=${gs}"
                echo "Response:"
                cat /tmp/resp.txt || true
                failed=$((failed+1))
              fi

              total=$((total+1))
              if (( THROTTLE_INT > 0 )); then
                sleep "${THROTTLE_INT}"
              fi
            done
          done

          echo "----------------------------------"
          echo "Dispatch complete. Total attempts: ${total}"
          echo "Failed dispatches: ${failed}"
          echo "----------------------------------"

          if (( failed > 0 )); then
            exit 1
          fi

name: CMB Phase Dagger (SMICA)

on:
  workflow_dispatch:
    inputs:
      lmax:
        description: "Max multipole l to analyze"
        required: true
        default: "128"
      nside:
        description: "HEALPix NSIDE for analysis"
        required: true
        default: "256"
      n_sims:
        description: "Number of phase-randomized surrogates"
        required: true
        default: "2000"
      seed:
        description: "RNG seed"
        required: true
        default: "0"
      n_bins:
        description: "Number of l-bins for variance-of-bin-means metric"
        required: true
        default: "8"
      field:
        description: "FITS field for temperature map (Planck products often use I_STOKES)"
        required: true
        default: "I_STOKES"
      mask_field:
        description: "FITS field for mask (use TMASK if present; blank disables mask)"
        required: false
        default: "TMASK"
      mask_thresh:
        description: "Mask threshold (>=). For TMASK, 0.9 is conservative."
        required: true
        default: "0.9"
      simulate_only:
        description: "If true, run smoke test on simulated Gaussian sky (no FITS download)."
        required: true
        default: "true"
      fits_url:
        description: "Direct URL to Planck PR3 SMICA full-sky FITS"
        required: true
        default: "https://irsa.ipac.caltech.edu/data/Planck/release_3/all-sky-maps/maps/component-maps/cmb/COM_CMB_IQU-smica_2048_R3.00_full.fits"

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy healpy

      - name: Run dagger (simulate OR SMICA FITS)
        run: |
          mkdir -p results/cmb_phase_dagger
          mkdir -p data/cmb

          SIM="${{ github.event.inputs.simulate_only }}"

          # Clean mask_field input: allow blank to disable masking
          MASK_FIELD="${{ github.event.inputs.mask_field }}"
          MASK_FIELD_TRIMMED="$(echo "$MASK_FIELD" | xargs)"

          if [ "$SIM" = "true" ]; then
            echo "Running SMOKE test (simulated Gaussian sky)..."
            python experiments/rgpx_proof_proto/cmb_phase_dagger/cmb_phase_dagger_smica.py \
              --simulate \
              --lmax "${{ github.event.inputs.lmax }}" \
              --nside "${{ github.event.inputs.nside }}" \
              --n_sims "${{ github.event.inputs.n_sims }}" \
              --seed "${{ github.event.inputs.seed }}" \
              --n_bins "${{ github.event.inputs.n_bins }}" \
              --out "results/cmb_phase_dagger/cmb_phase_dagger_report.json"
          else
            echo "Downloading SMICA FITS..."
            curl -L "${{ github.event.inputs.fits_url }}" -o data/cmb/smica.fits
            ls -lh data/cmb/smica.fits

            echo "Running dagger on REAL SMICA FITS..."
            if [ -z "$MASK_FIELD_TRIMMED" ]; then
              python experiments/rgpx_proof_proto/cmb_phase_dagger/cmb_phase_dagger_smica.py \
                --fits "data/cmb/smica.fits" \
                --field "${{ github.event.inputs.field }}" \
                --mask_thresh "${{ github.event.inputs.mask_thresh }}" \
                --lmax "${{ github.event.inputs.lmax }}" \
                --nside "${{ github.event.inputs.nside }}" \
                --n_sims "${{ github.event.inputs.n_sims }}" \
                --seed "${{ github.event.inputs.seed }}" \
                --n_bins "${{ github.event.inputs.n_bins }}" \
                --out "results/cmb_phase_dagger/cmb_phase_dagger_report.json"
            else
              python experiments/rgpx_proof_proto/cmb_phase_dagger/cmb_phase_dagger_smica.py \
                --fits "data/cmb/smica.fits" \
                --field "${{ github.event.inputs.field }}" \
                --mask_field "$MASK_FIELD_TRIMMED" \
                --mask_thresh "${{ github.event.inputs.mask_thresh }}" \
                --lmax "${{ github.event.inputs.lmax }}" \
                --nside "${{ github.event.inputs.nside }}" \
                --n_sims "${{ github.event.inputs.n_sims }}" \
                --seed "${{ github.event.inputs.seed }}" \
                --n_bins "${{ github.event.inputs.n_bins }}" \
                --out "results/cmb_phase_dagger/cmb_phase_dagger_report.json"
            fi
          fi

      - name: Upload result artifact
        uses: actions/upload-artifact@v4
        with:
          name: cmb_phase_dagger_report
          path: results/cmb_phase_dagger/cmb_phase_dagger_report.json

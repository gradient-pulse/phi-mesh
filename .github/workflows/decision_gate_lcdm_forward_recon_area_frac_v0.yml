name: "Decision gate (2A): ΛCDM φ_lm forward sims (CAMB C_L^{φφ}) — AreaFrac V0"

on:
  workflow_dispatch:
    inputs:
      lmax:
        description: "Max multipole L for phi_lm"
        required: true
        default: "256"
      nside:
        description: "HEALPix nside for topology"
        required: true
        default: "256"
      n_lcdm_sims:
        description: "Number of ΛCDM forward phi draws"
        required: true
        default: "20"
      n_phase_sims:
        description: "Phase-random surrogates per forward phi draw"
        required: true
        default: "2000"
      seed0:
        description: "Base RNG seed for forward sims"
        required: true
        default: "1200"
      # CAMB cosmology (defaults are Planck-like)
      H0:
        description: "H0"
        required: true
        default: "67.4"
      ombh2:
        description: "Omega_b h^2"
        required: true
        default: "0.0224"
      omch2:
        description: "Omega_c h^2"
        required: true
        default: "0.120"
      tau:
        description: "tau"
        required: true
        default: "0.054"
      As:
        description: "As"
        required: true
        default: "2.1e-9"
      ns:
        description: "ns"
        required: true
        default: "0.965"

permissions:
  contents: write

concurrency:
  group: decision-gate-lcdm-phi-forward-v0
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (pip-safe)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install numpy scipy healpy camb

      - name: Run ΛCDM phi forward sims + AreaFrac V0
        run: |
          set -euo pipefail
          mkdir -p results/cmb_topology_area_frac_v0 data/lcdm_phi

          python - <<'PY'
          import os, json, glob
          import numpy as np
          import healpy as hp
          import camb

          lmax = int("${{ github.event.inputs.lmax }}")
          nside = int("${{ github.event.inputs.nside }}")
          n_lcdm_sims = int("${{ github.event.inputs.n_lcdm_sims }}")
          n_phase_sims = int("${{ github.event.inputs.n_phase_sims }}")
          seed0 = int("${{ github.event.inputs.seed0 }}")

          H0 = float("${{ github.event.inputs.H0 }}")
          ombh2 = float("${{ github.event.inputs.ombh2 }}")
          omch2 = float("${{ github.event.inputs.omch2 }}")
          tau = float("${{ github.event.inputs.tau }}")
          As = float("${{ github.event.inputs.As }}")
          ns = float("${{ github.event.inputs.ns }}")

          # CAMB setup for lensing potential power spectrum
          pars = camb.CAMBparams()
          pars.set_cosmology(H0=H0, ombh2=ombh2, omch2=omch2, mnu=0.06, omk=0, tau=tau)
          pars.InitPower.set_params(As=As, ns=ns, r=0)
          pars.set_for_lmax(lmax, lens_potential_accuracy=1)
          results = camb.get_results(pars)

          # CAMB returns [L(L+1)]^2 C_L^{phi phi} / (2pi) etc internally;
          # get_lens_potential_cls gives C_L^{phi phi} in the conventional normalization expected by synalm.
          clpp = np.array(results.get_lens_potential_cls(lmax=lmax)[:lmax+1, 0], dtype=float)
          clpp[0:2] = 0.0

          out_dir = "results/cmb_topology_area_frac_v0"
          sim_records = []

          for i in range(n_lcdm_sims):
            sim_seed = seed0 + i
            np.random.seed(sim_seed)

            alm_phi = hp.synalm(clpp, lmax=lmax, new=True, verbose=False)
            alm_zero = np.zeros_like(alm_phi)

            dat_tmp = f"data/lcdm_phi/lcdm_phi_dat__sim{i:03d}.fits"
            mf_tmp  = f"data/lcdm_phi/lcdm_phi_mf__sim{i:03d}.fits"

            hp.write_alm(dat_tmp, alm_phi, overwrite=True)
            hp.write_alm(mf_tmp,  alm_zero, overwrite=True)

            out_json = os.path.join(
              out_dir,
              f"lcdm_phi_forward__area_frac_v0__sim{i:03d}__lmax{lmax}__nside{nside}__phasesims{n_phase_sims}__seed{sim_seed}__run${{ github.run_id }}.json"
            )

            cmd = (
              "python experiments/rgpx_proof_proto/cmb_phase_dagger/cmb_topology_planck_lensing__area_frac__v0.py "
              f"--dat_klm {dat_tmp} --mf_klm {mf_tmp} "
              f"--lmax {lmax} --nside {nside} --n_sims {n_phase_sims} --seed {sim_seed} "
              f"--n_nu 61 --nu_min -3.0 --nu_max 3.0 "
              f"--dat_url LCDM_PHI_FORWARD_CAMB --mf_url MF_ZERO "
              f"--out {out_json}"
            )
            rc = os.system(cmd)
            if rc != 0:
              raise RuntimeError(f"AreaFrac V0 failed on sim {i} (seed={sim_seed}).")

            with open(out_json, "r") as f:
              simj = json.load(f)

            Dj = float(simj["observed"]["D_L2"])
            sim_records.append({"sim": i, "seed": sim_seed, "D_L2": Dj, "out_json": out_json})

          summary = {
            "kind": "decision_gate_lcdm_phi_forward_area_frac_v0",
            "run_id": int("${{ github.run_id }}"),
            "inputs": {
              "lmax": lmax,
              "nside": nside,
              "n_lcdm_sims": n_lcdm_sims,
              "n_phase_sims": n_phase_sims,
              "seed0": seed0,
              "cosmology": {"H0": H0, "ombh2": ombh2, "omch2": omch2, "tau": tau, "As": As, "ns": ns},
            },
            "per_sim": sim_records,
            "D_stats": {
              "D_mean": float(np.mean([r["D_L2"] for r in sim_records])),
              "D_std": float(np.std([r["D_L2"] for r in sim_records], ddof=1)) if len(sim_records) > 1 else None,
            },
          }

          sum_path = os.path.join(out_dir, f"summary__lcdm_phi_forward__lmax{lmax}__nside{nside}__nsim{n_lcdm_sims}__run${{ github.run_id }}.json")
          with open(sum_path, "w") as f:
            json.dump(summary, f, indent=2)

          print("Wrote summary:", sum_path)
          PY

          ls -lh results/cmb_topology_area_frac_v0 | sed -n '1,200p'

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: decision_gate_lcdm_phi_forward_area_frac_v0__run${{ github.run_id }}
          path: results/cmb_topology_area_frac_v0/*.json
          retention-days: 90

      - name: Archive results into repo (controls/lcdm_phi_forward)
        run: |
          set -euo pipefail

          BASE_DIR="experiments/rgpx_proof_proto/cmb_phase_dagger/results/topology_area_frac_v0"
          RUN_DIR="${BASE_DIR}/controls/lcdm_phi_forward/runs/${{ github.run_id }}"
          mkdir -p "$RUN_DIR"

          cp -v results/cmb_topology_area_frac_v0/*.json "$RUN_DIR/"

          cat > "${RUN_DIR}/manifest.txt" <<EOF
          run_id: ${{ github.run_id }}
          workflow: ${{ github.workflow }}
          ref: ${{ github.ref }}
          sha: ${{ github.sha }}
          control: lcdm_phi_forward_camb_synalm
          lmax: ${{ github.event.inputs.lmax }}
          nside: ${{ github.event.inputs.nside }}
          n_lcdm_sims: ${{ github.event.inputs.n_lcdm_sims }}
          n_phase_sims: ${{ github.event.inputs.n_phase_sims }}
          seed0: ${{ github.event.inputs.seed0 }}
          EOF

      - name: Commit archived results (if changed) and push safely
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add experiments/rgpx_proof_proto/cmb_phase_dagger/results/topology_area_frac_v0/controls/lcdm_phi_forward/runs/${{ github.run_id }}/

          if git diff --cached --quiet; then
            echo "No new archived control files to commit."
            exit 0
          fi

          git commit -m "Decision gate: ΛCDM phi forward control (AreaFrac v0) (run ${{ github.run_id }})"

          for i in 1 2 3; do
            git fetch origin main
            git rebase origin/main || (git rebase --abort && exit 1)
            if git push; then
              echo "Push succeeded."
              exit 0
            fi
            echo "Push failed (attempt $i). Retrying..."
            sleep 3
          done

          echo "Push failed after retries."
          exit 1

name: CMB Topology (Planck PR3 Lensing φ_lm) — MF V0+V1

on:
  workflow_dispatch:
    inputs:
      dat_url:
        description: "Release asset URL for dat_klm (phi_lm MV estimate)"
        required: true
        default: "https://github.com/gradient-pulse/phi-mesh/releases/download/data-2026-02-15-planck-lensing-R3/planck_pr3_lensing_mv_dat_klm.fits"
      mf_url:
        description: "Release asset URL for mf_klm (mean-field correction)"
        required: true
        default: "https://github.com/gradient-pulse/phi-mesh/releases/download/data-2026-02-15-planck-lensing-R3/planck_pr3_lensing_mv_mf_klm.fits"
      lmax:
        description: "Max multipole l to analyze"
        required: true
        default: "256"
      nside:
        description: "HEALPix nside for map-space topology"
        required: true
        default: "256"
      n_sims:
        description: "Number of surrogates"
        required: true
        default: "2000"
      seed:
        description: "RNG seed"
        required: true
        default: "731"
      n_nu:
        description: "Number of thresholds between nu_min and nu_max"
        required: true
        default: "61"
      nu_min:
        description: "Min threshold (in sigma units after standardization)"
        required: true
        default: "-3.0"
      nu_max:
        description: "Max threshold (in sigma units after standardization)"
        required: true
        default: "3.0"

permissions:
  contents: write

concurrency:
  group: topology-mf-v0-v1-archive
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy healpy scipy

      - name: Download release assets
        run: |
          set -euo pipefail
          mkdir -p data/planck_lensing results/cmb_topology_mf_v0_v1
          curl -L --retry 5 --retry-delay 5 --fail "${{ github.event.inputs.dat_url }}" -o data/planck_lensing/dat_klm.fits
          curl -L --retry 5 --retry-delay 5 --fail "${{ github.event.inputs.mf_url }}"  -o data/planck_lensing/mf_klm.fits
          ls -lh data/planck_lensing

      - name: Run Topology MF V0+V1
        run: |
          set -euo pipefail

          # Include run_id so repeated parameter runs never overwrite each other
          OUT="results/cmb_topology_mf_v0_v1/planck_lensing_topology_mf_v0_v1__lmax${{ github.event.inputs.lmax }}__nside${{ github.event.inputs.nside }}__nsims${{ github.event.inputs.n_sims }}__seed${{ github.event.inputs.seed }}__run${{ github.run_id }}.json"

          python experiments/rgpx_proof_proto/cmb_phase_dagger/cmb_topology_planck_lensing__mf_v0_v1.py \
            --dat_klm data/planck_lensing/dat_klm.fits \
            --mf_klm  data/planck_lensing/mf_klm.fits \
            --lmax "${{ github.event.inputs.lmax }}" \
            --nside "${{ github.event.inputs.nside }}" \
            --n_sims "${{ github.event.inputs.n_sims }}" \
            --seed "${{ github.event.inputs.seed }}" \
            --n_nu "${{ github.event.inputs.n_nu }}" \
            --nu_min "${{ github.event.inputs.nu_min }}" \
            --nu_max "${{ github.event.inputs.nu_max }}" \
            --dat_url "${{ github.event.inputs.dat_url }}" \
            --mf_url "${{ github.event.inputs.mf_url }}" \
            --out "$OUT"

          echo "Wrote $OUT"
          ls -lh results/cmb_topology_mf_v0_v1

      - name: Upload result artifact
        uses: actions/upload-artifact@v4
        with:
          name: planck_lensing_topology_mf_v0_v1__lmax${{ github.event.inputs.lmax }}__nside${{ github.event.inputs.nside }}__nsims${{ github.event.inputs.n_sims }}__seed${{ github.event.inputs.seed }}__run${{ github.run_id }}
          path: results/cmb_topology_mf_v0_v1/*.json
          retention-days: 90

      - name: Archive result into repo (run history)
        run: |
          set -euo pipefail

          BASE_DIR="experiments/rgpx_proof_proto/cmb_phase_dagger/results/topology_mf_v0_v1"
          RUN_DIR="${BASE_DIR}/runs/${{ github.run_id }}"
          mkdir -p "$RUN_DIR"

          cp -v results/cmb_topology_mf_v0_v1/*.json "$RUN_DIR/"

          cat > "${RUN_DIR}/manifest.txt" <<EOF
          run_id: ${{ github.run_id }}
          workflow: ${{ github.workflow }}
          ref: ${{ github.ref }}
          sha: ${{ github.sha }}
          lmax: ${{ github.event.inputs.lmax }}
          nside: ${{ github.event.inputs.nside }}
          n_sims: ${{ github.event.inputs.n_sims }}
          seed: ${{ github.event.inputs.seed }}
          dat_url: ${{ github.event.inputs.dat_url }}
          mf_url: ${{ github.event.inputs.mf_url }}
          EOF

          ls -lh "$RUN_DIR"

      - name: Commit archived result (if changed) and push safely
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add experiments/rgpx_proof_proto/cmb_phase_dagger/results/topology_mf_v0_v1/runs/${{ github.run_id }}/

          if git diff --cached --quiet; then
            echo "No new archived files to commit."
            exit 0
          fi

          git commit -m "Archive Planck lensing topology MF v0+v1 (run ${{ github.run_id }})"

          for i in 1 2 3; do
            git fetch origin main
            git rebase origin/main || (git rebase --abort && exit 1)

            if git push; then
              echo "Push succeeded."
              exit 0
            fi

            echo "Push failed (attempt $i). Retrying after short delay..."
            sleep 3
          done

          echo "Push failed after retries."
          exit 1
